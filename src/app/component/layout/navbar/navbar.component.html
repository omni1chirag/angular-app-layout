<div class="layout-topbar">
    <div class="layout-topbar-logo-container">
        <button class="layout-menu-button layout-topbar-action" (click)="layoutService.onMenuToggle()">
            <i class="pi pi-bars"></i>
        </button>
        <button class="layout-topbar-logo" (click)="navigateToDashboard()">
            <img alt="" width="120">
        </button>
    </div>

    <div class="flex flex-col items-center w-full gap-4 md:flex-row">
        <!-- Combined Input Group -->
        <div class="relative flex w-full max-w-4xl" #searchWrapper>
            <!-- Location Dropdown -->
            <div
                class="flex items-center border-1 border-e-0 border-[#cbd5e1] border-surface-100 rounded-s-lg bg-surface-0 focus-within:border-primary-500 focus-within:z-10 transition-all duration-200 h-[40px]">
                <span class="px-3 text-surface-400">
                    <i class="text-lg pi pi-map-marker"></i>
                </span>
                <p-select [options]="locationOptions" [(ngModel)]="city" optionLabel="city" optionValue="value"
                    [filter]="true" [appendTo]="'body'" placeholder="Location" styleClass="border-0 rounded-none"
                    [style]="{minWidth:'180px', border: 'none'}" [virtualScroll]="true" [virtualScrollItemSize]="50">
                    <ng-template let-result pTemplate="item">
                        <i class="text-lg pi pi-map-marker"></i>
                        <div class="ml-2">
                            <span class="text-base font-normal"> {{result.city}}</span>
                            <p class="text-sm">{{result.state}}</p>
                        </div>
                    </ng-template>
                    <ng-template #header>
                        <div class="px-3 py-2 font-medium">Available Locations</div>
                    </ng-template>
                </p-select>
            </div>

            <!-- Main Search Input -->
            <div class="relative flex-1 h-[40px]">
                <i class="absolute z-10 text-lg -translate-y-1/2 text-surface-400 pi pi-search start-4 top-1/2"></i>
                <input pInputText [(ngModel)]="searchQuery" (input)="onSearchChange()" (focus)="onInputFocus()"
                    placeholder="Search doctors, clinics, specialities..."
                    class="w-full h-full text-base transition-all duration-200 border-1 border-[#cbd5e1] ps-12 pe-12 border-surface-100 rounded-e-lg rounded-s-none focus:outline-none focus:border-primary-500 focus:z-10">
                <button *ngIf="searchQuery" (click)="clearSearch()"
                    class="absolute z-10 transition-colors -translate-y-1/2 text-surface-400 end-4 top-1/2 hover:text-surface-600">
                    <i class="text-lg pi pi-times"></i>
                </button>
            </div>

            <!-- Autocomplete Dropdown -->
            <div *ngIf="searchQuery && showDropdown"
                class="absolute z-50 mt-2 w-full bg-surface-0 bg-white dark:bg-gray-900 rounded-2xl shadow-lg border border-surface-200 max-h-[28rem] overflow-hidden top-full start-0">
                <!-- Tabs -->
                <div class="px-6 pt-4 border-b border-surface-200">
                    <div class="flex gap-6">
                        <button *ngFor="let tab of tabs" (click)="activeTab = tab.key"
                            [ngClass]="getTabClasses(tab.key)"
                            class="px-1 pb-3 text-sm sm:text-base font-medium transition-colors duration-200 border-b-2">
                            {{ tab.label }} <span class="text-surface-500">({{ getTabCount(tab.key) }})</span>
                        </button>
                    </div>
                </div>

                <!-- Results Scrollable -->
                <div class="p-6 overflow-y-auto max-h-80">
                    <div *ngIf="getFilteredResults().length === 0" class="py-8 text-center text-surface-500">
                        <i class="block mb-4 text-4xl pi pi-search"></i>
                        <p>No results found</p>
                    </div>

                    <!-- Doctors -->
                    <div *ngIf="(activeTab==='doctors' || activeTab==='all') && getDoctorResults().length > 0"
                        >
                        <h5 *ngIf="activeTab==='all'" class="mb-2 text-sm sm:text-base font-semibold text-surface-500">
                            Doctors</h5>
                        <button *ngFor="let doctor of getDoctorResults(); trackBy: trackByDoctor" type="button"
                            class="flex items-center w-full gap-4 p-3 rounded-lg cursor-pointer text-start hover:bg-surface-50"
                            (click)="selectItem(doctor)">
                            <p-avatar *ngIf="!doctor?.imageError" [image]="doctor?.imageUrl"
                                (onImageError)="doctor.imageError = true" shape="circle" size="large"
                                class="border rounded-full shadow-sm border-surface-200 justify-self-center">
                            </p-avatar>

                            <p-avatar *ngIf="doctor?.imageError" icon="pi pi-user" [label]="setInitials(doctor)"
                                class="border rounded-full shadow-sm border-surface-200 justify-self-center"
                                shape="circle" size="large"
                                [style]="{ 'background-color': 'var(--p-button-outlined-primary-active-background)', color: 'var(--p-button-outlined-primary-color)' }">
                            </p-avatar>
                            <div class="flex-1 w-0">
                                <h5 class="text-base font-semibold truncate !mb-0">{{ doctor.name }}</h5>
                                <p class="text-sm text-surface-600 truncate !mb-0" [title]="doctor.category">{{
                                    doctor.category | slice:0:100 }}
                                    <span *ngIf="doctor.category?.length > 100">... more</span>
                                </p>
                                <span class="text-[12px] text-surface-600 truncate !mb-0">

                                  <div class="flex flex-wrap gap-2">
                                    @for (charge of doctor.consultationCharges; track $index) {
                                     <p-chip
                                        class=" flex items-center border border-gray-300 !pl-2 !pr-2 !pt-1 !pb-1"
                                      >
                                        <span class="font-semibold text-gray-800">
                                          {{ charge.appointmentType }}
                                        </span>
                                       <span class="text-gray-700 flex items-end">
                                        ₹{{ charge.payableAmount | number:'1.0-2' }}
                                      </span>
                                        <span
                                          *ngIf="
                                            charge.displayAmount &&
                                            charge.displayAmount !== charge.payableAmount
                                          "
                                          class="text-gray-500 line-through"
                                        >
                                          ₹{{ charge.displayAmount | number : "1.0-2" }}
                                        </span>
                                      </p-chip>
                                    }
                                  </div>
                                </span>
                            </div>
                        </button>
                        <button *ngIf="searchResults.doctors.totalCount > 1"
                            class="block px-4 py-2 mx-auto mt-2 text-sm font-medium transition-all border rounded-md text-primary-600 border-primary-600 hover:bg-primary-50 hover:text-primary-800 focus:outline-none focus:ring-2 focus:ring-primary-300 active:bg-primary-100"
                            (click)="onViewAllClick('/home/doctors')">
                            View all ({{searchResults.doctors.totalCount}}) doctors
                        </button>
                    </div>

                    <!-- Clinics -->
                    <div *ngIf="(activeTab==='clinics' || activeTab==='all') && getClinicResults().length > 0"
                        >
                        <h5 *ngIf="activeTab==='all'" class="mb-2 text-sm sm:text-base font-semibold text-surface-500">
                            Clinics</h5>
                        <button *ngFor="let clinic of getClinicResults()"
                            class="flex items-center w-full gap-4 p-3 rounded-lg cursor-pointer text-start hover:bg-surface-50"
                            (click)="selectItem(clinic)">
                            <p-avatar *ngIf="!clinic?.imageError" [image]="clinic?.imageUrl"
                                (onImageError)="clinic.imageError = true" shape="circle" size="large"
                                class="border rounded-full shadow-sm border-surface-200 justify-self-center">
                            </p-avatar>

                            <p-avatar *ngIf="clinic?.imageError" icon="pi pi-building"
                                [style]="{'background-color': 'var(--p-button-outlined-primary-active-background)', 'color': 'var(--p-button-outlined-primary-color)' }"
                                shape="circle" class="justify-self-center" size="large">
                            </p-avatar>

                            <div class="flex-1">
                                <h5 class="text-base font-semibold truncate !mb-0">{{ clinic.name }}</h5>
                                <p class="text-sm text-surface-600 !mb-0">{{ clinic.doctorsCount }} doctors • {{
                                    clinic.location }}</p>
                            </div>
                        </button>
                        <button *ngIf="searchResults.clinics.totalCount > 10"
                            class="block px-4 py-2 mx-auto mt-2 text-sm font-medium transition-all border rounded-md text-primary-600 border-primary-600 hover:bg-primary-50 hover:text-primary-800 focus:outline-none focus:ring-2 focus:ring-primary-300 active:bg-primary-100"
                            (click)="onViewAllClick('/home/clinics')">
                            View all ({{searchResults.clinics.totalCount}}) Clinics
                        </button>
                    </div>

                    <!-- Specialities -->
                    <div *ngIf="(activeTab==='specialities' || activeTab==='all') && getSpecialityResults().length > 0"
                        >
                        <h5 *ngIf="activeTab==='all'" class="mb-2 text-sm sm:text-base font-semibold text-surface-500">Specialities
                        </h5>

                        <!-- Speciality List -->
                        <div class="grid gap-2">
                            <button *ngFor="let spec of getSpecialityResults(); trackBy: trackBySpeciality"
                                class="flex items-center gap-4 p-3 transition-all rounded-lg cursor-pointer hover:bg-surface-50 focus:outline-none focus:ring-2 focus:ring-primary-300"
                                (click)="selectItem(spec)">
                                <!-- Default Medical Icon -->
                                <div class="shrink-0">
                                    <p-avatar icon="pi pi-briefcase-medical" shape="circle" size="large"
                                        class="border shadow-sm text-primary-600 bg-primary-100 border-primary-200">
                                    </p-avatar>
                                </div>

                                <!-- Speciality Info -->
                                <div class="flex-1 text-start">
                                    <h6 class="text-base font-semibold truncate !mb-0">{{ spec.name }}</h6>
                                    <p class="text-sm text-surface-600 !mb-0">{{ spec.doctorsCount }} {{ spec.doctorsCount ===
                                        1 ? 'doctor' : 'doctors' }} available</p>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="layout-topbar-actions">
        <p-select *ngIf="patientProfiles()?.length > 0" [options]="patientProfiles()" [(ngModel)]="activePatientProfile"
            optionLabel="patientName" optionValue="patientId" (onChange)="patientChange($event)"
            [disabled]="patientProfiles()?.length === 1" placeholder="Select a Profile"
            class="w-full sm:w-60 md:w-46 lg:w-56" />
        <button *ngIf="!isAdminUser" pButton type="button" class="p-button-text p-overlay-badge mt-0.5"
            (click)="notif.toggleNotifications($event)">
            <i class="pi pi-bell" style="font-size: 1.3rem;"></i>
            <span class="text-red-500 p-badge badge-small">{{ notificationCount() }}</span>
        </button>
        <div class="layout-config-menu" style="margin-left: -20px;">
            <button type="button" class="layout-topbar-action" (click)="toggleDarkMode()">
                <i
                    [ngClass]="{ 'pi ': true, 'pi-moon': layoutService.isDarkTheme(), 'pi-sun': !layoutService.isDarkTheme() }"></i>
            </button>
        </div>

        <button type="button" class="layout-topbar-action" (click)="layoutService.onToggleUserMenu()">
            <i class="pi pi-user"></i>
            <span>Profile</span>
        </button>
    </div>
</div>

<p-confirmdialog key="profile-change" [position]="'top'" [appendTo]="'body'"></p-confirmdialog>
<app-notification #notif></app-notification>
