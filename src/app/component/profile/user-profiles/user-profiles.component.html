<div pageHeader>
    <p-toolbar>
        <ng-template #start>
            <p class="text-2xl font-bold sm:truncate sm:text-3xl sm:tracking-tight">
                @if (mode === 'update') {
                {{ 'PATIENT.UPDATE_PROFILE' | translate }}
                } @else {
                {{ 'PATIENT.ADD_FAMILY_MEMBER' | translate }}
                }
            </p>
        </ng-template>

        <ng-template #center>
        </ng-template>

        <ng-template #end>
            <div class="flex space-x-3 justify-items-end">
                <p-button label="{{ 'SAVE' | translate }}" [loading]="isCallInitiated" [disabled]="isCallInitiated"
                    (onClick)="save()" />
                <p-button label="{{ 'CANCEL' | translate }}" variant="outlined" severity="danger"
                    (onClick)="cancel()" />
            </div>
        </ng-template>
    </p-toolbar>
</div>

<form [formGroup]="profileForm" *ngIf="profileForm">    
    <div class="card">
        <div>
            <h4 class="font-semibold text-gray-900 text-base/7">{{ 'PATIENT.BASIC_DETAILS' | translate }}</h4>
        </div>
        <p-divider></p-divider>

        <div class="grid grid-cols-12 gap-3 mt-5">

            <div class="flex flex-col col-start-1 col-span-full sm:col-span-6 md:col-span-1 lg:col-span-1">
                <label for="title">{{ 'PATIENT.TITLE' | translate }}</label>
                <div class="mt-2">
                    <p-select id="title" formControlName="title" [options]="titles" optionLabel="label"
                        optionValue="value" placeholder="{{ 'PATIENT.PLACE_HOLDER.TITLE' | translate }}" class="w-full"
                        class="w-full">
                    </p-select>
                </div>
            </div>

            <div class="flex flex-col col-span-full sm:col-span-6 md:col-span-3 lg:col-span-2">
                <label mandatoryFieldLabel for="firstName">{{ 'PATIENT.FIRST_NAME' | translate }}</label>
                <div class="mt-2">
                    <input pInputText type="text" name="firstName" id="firstName" formControlName="firstName"
                        autocomplete="family-name" class="w-full" maxlength="50"
                        placeholder="{{ 'PATIENT.PLACE_HOLDER.FIRST_NAME' | translate }}">
                </div>
            </div>
            <div class="flex flex-col col-span-full sm:col-span-6 md:col-span-3 lg:col-span-2">
                <label for="middleName">{{ 'PATIENT.MIDDLE_NAME' | translate }}</label>
                <div class="mt-2">
                    <input pInputText type="text" name="middleName" id="middleName" formControlName="middleName"
                        autocomplete="family-name" class="w-full" maxlength="50"
                        placeholder="{{ 'PATIENT.PLACE_HOLDER.MIDDLE_NAME' | translate }}">
                </div>
            </div>
            <div class="flex flex-col col-span-full sm:col-span-6 md:col-span-3 lg:col-span-2">
                <label mandatoryFieldLabel for="last-name">{{ 'PATIENT.LAST_NAME' | translate }}</label>
                <div class="mt-2">
                    <input pInputText type="text" name="lastName" id="last-name" formControlName="lastName"
                        autocomplete="family-name" class="w-full" maxlength="50"
                        placeholder="{{ 'PATIENT.PLACE_HOLDER.LAST_NAME' | translate }}">
                </div>
            </div>

            <div class="flex flex-col col-span-full sm:col-span-6 md:col-span-2">
                <label mandatoryFieldLabel for="last-name">{{ 'PATIENT.DATE_OF_BIRTH' | translate }}</label>
                <div class="mt-2">
                    <p-datepicker dateFormat="dd/mm/yy" class="w-full" [iconDisplay]="'input'" dateMask
                        [maxDate]="currentDate" formControlName="dateOfBirth" [showIcon]="true" [minDate]="minDateOfBirth"
                        [style]="{'width': '100%'}" (onSelect)="calculateAge()" (onClose)="calculateAge()"
                        placeholder="DD/MM/YYYY" />
                </div>
            </div>

            <div class="flex flex-col col-span-full sm:col-span-6 md:col-span-1">
                <label for="age">{{ 'PATIENT.AGE' | translate }}</label>
                <div class="mt-2">
                    <input pInputText type="text" formControlName="age" name="age" id="age" class="w-full">
                </div>
            </div>

            <div
                class="flex flex-col col-start-1 sm:col-start-1 md:col-start-1 lg:col-start-1 col-span-full sm:col-span-6 md:col-span-1 lg:col-span-1">
                <label mandatoryFieldLabel for="gender">{{ 'PATIENT.GENDER' | translate }}</label>
                <div class="mt-2">
                    <p-select id="gender" formControlName="gender" [options]="genders" optionLabel="label"
                        optionValue="value" placeholder="{{ 'PATIENT.PLACE_HOLDER.GENDER' | translate }}" class="w-full"
                        class="w-full">
                    </p-select>
                </div>
            </div>
            <div class="flex flex-col col-span-full sm:col-span-6 md:col-span-6 lg:col-span-2" *ngIf="gender">
                <label for="genderFreeText">&nbsp;</label>
                <div class="mt-2">
                    <input pInputText type="text" name="genderFreeText" id="genderFreeText"
                        formControlName="genderFreeText" class="w-full"
                        placeholder="{{ 'PATIENT.PLACE_HOLDER.GENDER_FREE_TEXT' | translate }}">
                </div>
            </div>


            <div class="flex flex-col col-span-full sm:col-span-6 md:col-span-2">
                <label for="state">{{ 'PATIENT.MARITAL_STATUS' | translate }}</label>
                <div class="flex mt-2">
                    <p-select id="MaritalStatus" formControlName="maritalStatus" [options]="maritalStatuses"
                        optionLabel="label" optionValue="value"
                        placeholder="{{ 'PATIENT.PLACE_HOLDER.MARITAL_STATUS' | translate }}" class="w-full"
                        class="w-full">
                    </p-select>
                </div>
            </div>
            <div class="flex flex-col col-span-full sm:col-span-6 md:col-span-6 lg:col-span-2" *ngIf="maritalStatus">
                <label for="maritalStatusFreeText">&nbsp;</label>
                <div class="mt-2">
                    <input pInputText type="text" name="maritalStatusFreeText" id="maritalStatusFreeText"
                        formControlName="maritalStatusFreeText" class="w-full"
                        placeholder="{{ 'PATIENT.PLACE_HOLDER.MARITAL_STATUS_FREE_TEXT' | translate }}">
                </div>
            </div>
            <div class="flex flex-col col-span-full sm:col-span-6 md:col-span-2">
                <label for="aadharNumber">{{ 'PATIENT.AADHAAR_NUMBER' | translate }}</label>
                <div class="mt-2">
                    <p-inputmask mask="9999 9999 9999" formControlName="aadharNumber" id="aadhaarNumber" class="w-full"
                        [unmask]="true" placeholder="9999 9999 9999" [style]="{'width':'100%'}" />
                </div>
            </div>
            <div class="flex flex-col col-span-full sm:col-span-6 md:col-span-2">
                <label for="abhaId">{{ 'PATIENT.ABHA_ID' | translate }}</label>
                <div class="mt-2">
                    <p-inputmask mask="9999-9999-9999-99" formControlName="abhaId" id="abhaId" class="w-full"
                        [unmask]="true" placeholder="9999-9999-9999-99" [style]="{'width':'100%'}" />
                </div>
            </div>
            <div class="flex flex-col col-span-full sm:col-span-6 md:col-span-3 lg:col-span-2">
                <label for="profilePicture" class="">{{ 'PATIENT.PROFILE_PICTURE' | translate }}</label>
                <div class="flex justify-start mt-2">
                    <app-file-upload formControlName="profilePicture" [moduleId]="2" [fileSize]="10" [subModuleId]="2"
                        source="Admin" [objectId]="patientId" [fileTypeSupported]="documentTypes"></app-file-upload>
                </div>
            </div>
            <div class="flex flex-col col-span-full sm:col-span-6 md:col-span-2 lg:col-span-1">
                <label for="bloodGroup">{{ 'PATIENT.BLOOD_GROUP' | translate }}</label>
                <div class="flex mt-2">
                    <p-select id="bloodGroup" formControlName="bloodGroup" [options]="bloodGroups" optionLabel="label"
                        optionValue="value" placeholder="{{ 'PATIENT.PLACE_HOLDER.BLOOD_GROUP' | translate
                        }}" class="w-full" class="w-full">
                    </p-select>
                </div>
            </div>
            @if (mode !== 'update' ) {
            <div class="flex flex-col col-span-full sm:col-span-6 md:col-span-2 lg:col-span-2">
                <label mandatoryFieldLabel for="joinCurrentUserAs">{{
                    'PATIENT.RELATIONSHIP' | translate }}</label>
                <div class="mt-2">
                    <p-select id="joinCurrentUserAs" formControlName="joinCurrentUserAs" appendTo="body"
                        [options]="userRelationShips" optionLabel="label" optionValue="value"
                        placeholder="{{ 'PATIENT.PLACE_HOLDER.RELATIONSHIP' | translate }}" class="w-full"
                        class="w-full">
                    </p-select>
                </div>
            </div>
            }

        </div>
    </div>

    <div class="card">
        <div>
            <h4 class="font-semibold text-gray-900 text-base/7">{{ 'PATIENT.CONTACT_DETAILS' | translate }}</h4>
        </div>
        <p-divider></p-divider>
        <app-address></app-address>
    </div>

    <div class="card">
        <div>
            <h4 class="font-semibold text-gray-900 text-base/7">{{ 'PATIENT.PREFERENCES' | translate }}</h4>
        </div>
        <p-divider></p-divider>
        <div class="grid grid-cols-12 gap-3 mt-5">

            <div class="flex flex-col col-span-full sm:col-span-6 md:col-span-3 lg:col-span-2">
                <label for="preferredLanguages">{{ 'PATIENT.PREFERRED_LANGUAGE' | translate
                    }}</label>
                <div class="mt-2">
                    <p-multiselect [options]="languages" placeholder="{{ 'PATIENT.PLACE_HOLDER.PREFERRED_LANGUAGE' | translate
                        }}" optionLabel="label" formControlName="preferredLanguages" optionValue="value" display="chip"
                        [filter]="true" class="w-full">
                    </p-multiselect>

                </div>
            </div>
            <div class="flex flex-col col-span-full sm:col-span-6 md:col-span-3 lg:col-span-2">
                <label for="communicationModes">{{ 'PATIENT.MODE_OF_COMMUNICATION' | translate
                    }}</label>
                <div class="mt-2">
                    <p-multiselect [options]="communicationModes" placeholder="{{ 'PATIENT.PLACE_HOLDER.SELECT_MODE_OF_COMMUNICATION' | translate
                        }}" placeholder="" formControlName="communicationModes" optionLabel="label" optionValue="value"
                        display="chip" [filter]="true" class="w-full">
                    </p-multiselect>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div>
            <h4 class="font-semibold text-gray-900 text-base/7">{{ 'PATIENT.EMERGENCY_CONTACT_DETAILS' | translate
                }}
            </h4>
        </div>
        <p-divider></p-divider>
        <div class="w-full mt-5">
            <ng-container formArrayName="emergencyContacts">
                <p-table [value]="getEmergencyContacts['controls']" [reorderableColumns]="true" size="small"
                    (onRowReorder)="onRowReorder()">
                    <ng-template #header let-columns>
                        <tr>
                            <th style="width:3%" scope="col"></th>
                            <th style="width:30%" scope="col">
                                <label for="emergencyContactName">
                                    {{ 'PATIENT.EMERGENCY_CONTACT_NAME' | translate }}
                                </label>
                            </th>
                            <th style="width:30%" scope="col">
                                <label for="emergencyContactNumber">
                                    {{ 'PATIENT.EMERGENCY_CONTACT_NUMBER' | translate }}
                                </label>
                            </th>
                            <th style="width:25%" scope="col">
                                <label for="relationshipToPatient">
                                    {{ 'PATIENT.RELATIONSHIP' | translate }}
                                </label>
                            </th>
                            <th style="width:12%" scope="col"></th>
                        </tr>

                    </ng-template>
                    <ng-template #body let-item let-index="rowIndex">
                        <tr [pReorderableRow]="index" [formGroupName]="index">
                            <td>
                                <span class="pi pi-bars" pReorderableRowHandle></span>
                            </td>
                            <td>
                                <input pInputText id="emergencyContactName" formControlName="contactName" type="text"
                                    maxlength="50"
                                    placeholder="{{ 'PATIENT.PLACE_HOLDER.EMERGENCY_CONTACT_NAME' | translate }}"
                                    class="w-full" />
                            </td>
                            <td>
                               <p-inputgroup>
                                  <p-inputgroup-addon>+91</p-inputgroup-addon>
                                  <p-inputnumber formControlName="contactNumber" phoneNumberMask name="emergencyContactNumber"
                                      placeholder="{{ 'PATIENT.PLACE_HOLDER.EMERGENCY_CONTACT_NUMBER' | translate }}"
                                      id="emergencyContactNumber" class="w-full" mode="decimal" inputId="withoutgrouping"
                                      [useGrouping]="false" [maxlength]="10" [minlength]="10" />
                              </p-inputgroup>
                            </td>
                            <td>
                                <p-select id="relationshipToPatient" formControlName="contactRelation" appendTo="body"
                                    [options]="patientRelationShips" optionLabel="label" optionValue="value"
                                    placeholder="{{ 'PATIENT.PLACE_HOLDER.RELATIONSHIP' | translate }}" class="w-full"
                                    class="w-full">
                                </p-select>
                            </td>
                            <td>
                                @if ((getEmergencyContacts['controls'].length - 1) === index) {
                                @if (getEmergencyContacts['controls'].length > 1) {

                                <p-button icon="pi pi-trash" variant="outlined" severity="danger" [raised]="false"
                                    (onClick)="removeEmergencyContact(index)" />
                                &nbsp;
                                }
                                <p-button icon="pi pi-plus" variant="outlined"
                                    (onClick)="addEmergencyContacts(undefined,true)" [raised]="false" />

                                } @else {
                                <p-button icon="pi pi-trash" variant="outlined" severity="danger" [raised]="false"
                                    (onClick)="removeEmergencyContact(index)" />
                                }
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </ng-container>
        </div>
    </div>

</form>


<app-insurance-list [patientId]="patient()"></app-insurance-list>
